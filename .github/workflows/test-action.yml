name: Test Error Identifier Action

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  # Test 1: ABI Mode (compile first, then extract)
  test-abi-mode:
    runs-on: ubuntu-latest
    name: Test ABI Mode
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm install

      - name: Compile contracts
        run: npx hardhat compile

      - name: Extract errors (ABI mode)
        uses: roeezolantz/solidity-error-identifier-action@master
        with:
          mode: 'abi'
          abi-paths: 'artifacts/contracts'
          output-path: 'errors-abi-mode.json'

      - name: Verify errors.json was created
        run: |
          if [ ! -f "errors-abi-mode.json" ]; then
            echo "‚ùå Error: errors-abi-mode.json not created!"
            exit 1
          fi
          echo "‚úÖ errors-abi-mode.json created successfully"
          cat errors-abi-mode.json | jq '.'

      - name: Check error count
        run: |
          ERROR_COUNT=$(cat errors-abi-mode.json | jq 'length')
          echo "Found $ERROR_COUNT errors"
          if [ "$ERROR_COUNT" -lt 5 ]; then
            echo "‚ùå Expected at least 5 errors, got $ERROR_COUNT"
            exit 1
          fi
          echo "‚úÖ Error count looks good: $ERROR_COUNT errors"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: errors-abi-mode
          path: errors-abi-mode.json

  # Test 2: Compile Mode (action compiles for us)
  test-compile-mode:
    runs-on: ubuntu-latest
    name: Test Compile Mode
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v4
        with:
          node-version: 20.x

      # NO compilation step - action does it!

      - name: Extract errors (Compile mode)
        uses: roeezolantz/solidity-error-identifier-action@master
        with:
          mode: 'compile'
          contract-paths: 'contracts'
          compiler: 'hardhat'
          solidity-version: '0.8.25'
          output-path: 'errors-compile-mode.json'

      - name: Verify errors.json was created
        run: |
          if [ ! -f "errors-compile-mode.json" ]; then
            echo "‚ùå Error: errors-compile-mode.json not created!"
            exit 1
          fi
          echo "‚úÖ errors-compile-mode.json created successfully"
          cat errors-compile-mode.json | jq '.'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: errors-compile-mode
          path: errors-compile-mode.json

  # Test 3: NPM Publishing Mode (LIVE - actually publishes to NPM!)
  test-npm-mode:
    runs-on: ubuntu-latest
    name: Test NPM Publishing (Live)
    permissions:
      contents: read
      id-token: write  # Required for NPM Provenance (Trusted Publishing)
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm install

      - name: Compile contracts
        run: npx hardhat compile

      # LIVE NPM PUBLISHING - Using token + provenance for secure publishing
      - name: Extract errors and publish to NPM
        uses: roeezolantz/solidity-error-identifier-action@master
        with:
          mode: 'abi'
          abi-paths: 'artifacts/contracts'
          output-path: 'errors.json'
          publish-npm: 'true'
          npm-package-name: '@roeezolantz/test-contract-errors'
          npm-binary-name: 'test-error-lookup'
          npm-token: ${{ secrets.NPM_TOKEN }}  # Authentication (use automation token)
          npm-provenance: 'true'  # Add cryptographic provenance attestation

      - name: Show published package info
        run: |
          echo "üì¶ Successfully published to NPM with provenance!"
          echo "Package: @roeezolantz/test-contract-errors"
          echo "Binary: test-error-lookup"
          echo ""
          echo "‚ú® Published with cryptographic provenance attestation"
          echo "   This proves the package was built by this GitHub Actions workflow"
          echo "   Verify provenance at: https://www.npmjs.com/package/@roeezolantz/test-contract-errors"
          echo ""
          echo "Error database contents:"
          cat errors.json | jq '.'
          echo ""
          echo "To install: npm install -g @roeezolantz/test-contract-errors"
          echo "To use: test-error-lookup <error-selector>"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: errors-npm-mode
          path: errors.json
